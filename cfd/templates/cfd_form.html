{% extends 'base.html' %}
{% load i18n static %}
{% load filters %}
{% load static %}

{% block main %}
     <form  method="post" id="cfd_form">{% csrf_token %}
         <div class="row">
            {% if formset %}
                {{ formset.management_form }}
                <div class="col">
                    {% include "snippets/formset.html" with formset=formset fieldsets=fieldsets R90_B_LIST=RETAIL_90_MAIL_RATES_B_LIST R90_G_LIST=RETAIL_90_MAIL_RATES_G_LIST %}
                </div>
            {% else %}
                <div class="col">
                    {% include "snippets/form_snippet.html" with form=form fieldsets=fieldsets index=0 last=True %}
                </div>
            {% endif %}           
         </div>

         
            
       <input class="btn btn-primary" type="submit" value="Save" />
    </form>

 {% endblock %}

{% block scripts %}

<script src="{% static '/admin/js/vendor/jquery/jquery.js' %}"></script>
<script src="{% static '/admin/js/jquery.init.js' %}"></script>
<script src="{% static '/admin/js/core.js' %}"></script>
<script type="text/javascript" src="{% url 'admin:jsi18n' %}"></script>
<script src="{% static '/js/collapse.js' %}"></script>

<script>

    $(document).ready(function(){
        $(".RETAIL_90_MAIL_RATES_B_FIELD").hide($("#id_RETAIL_90_MAIL_RATES_B").val().substring(0,1) != "Y");
        $(".RETAIL_90_MAIL_RATES_G_FIELD").hide($("#id_RETAIL_90_MAIL_RATES_B").val().substring(0,1) != "Y");

        $("#id_RETAIL_90_MAIL_RATES_B").change(function(){
            $(".RETAIL_90_MAIL_RATES_B_FIELD").toggle($("#id_RETAIL_90_MAIL_RATES_B").val() != "N");
            });

        $("#id_RETAIL_90_MAIL_RATES_G").change(function(){
            $(".RETAIL_90_MAIL_RATES_G_FIELD").toggle($("#id_RETAIL_90_MAIL_RATES_G").val() != "N");
            });
    });

    $(".input-copy").click(function(e){
        e.preventDefault();
        var elem = e.target;        
        var parent = elem.parentElement;    
        var inputField = document.getElementById(parent.dataset.target);

        var currentIndex = Number(parent.dataset.index);
        var fieldNameSuffix = inputField.name.split("-");
        fieldNameSuffix = fieldNameSuffix.slice(2, fieldNameSuffix.length);
        fieldNameSuffix = fieldNameSuffix.join("-");   

        while (true){            
            var nextFieldName = "form-" + String(currentIndex + 1) + "-" + fieldNameSuffix;
            var nextField = document.getElementsByName(nextFieldName)[0];

            if (nextField == undefined || nextField == null) {
                break
            }
            
            nextField.value = inputField.value;

            currentIndex += 1;
        }
        
    })


    $(".section-copy").click(function(e){
        e.preventDefault();

        var index = e.target.dataset.index;
        var fieldset = closestElem(e.target, 'fieldset');

        var inputs = fieldset.querySelectorAll('input');
        var selects = fieldset.querySelectorAll('select');
        
        var copySection = function(sourceIndex, nodeList, nodesPerRow){
            /** 
             * This function copies the value of the specified field to all 
             * other forms in the formset.
             * Here, a nodeMatrix is built with N rows and M columns where N is the 
             * number of fields in the fieldset and M is the number of forms in the 
             * formset or nodesPerRow.
             * The value at the chosen index for each row is copied to every other 
             * field in the same row.
            **/

            var nodeMatrix = [];

            nodeList = Array.from(nodeList);
            for (var count = 0; count < nodeList.length / nodesPerRow; count++){
                // 0 3
                // 3 6
                // 6 9
                nodeMatrix.push(nodeList.slice(count * nodesPerRow, (count + 1) * nodesPerRow));
            }

            for (var count = 0; count < nodeMatrix.length; count++){
                var currentItem = nodeMatrix[count];
                var value = currentItem[index].value;

                for (var i = 0; i < nodesPerRow; i++){
                    if (i !== index){
                        currentItem[i].value = value;
                    }
                }
            }
        }

        copySection(index, inputs, 3);
        copySection(index, selects, 3);
    })

    $('cfd_form :input').change(function(){
        alert("Form changed");
    });

</script>
{% endblock %}